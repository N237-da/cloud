# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
name: Simple CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Récupérer le code
      - uses: actions/checkout@v4
      
      # 2. Build l'application Java
      - name: Build Java app
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
        run: |
          chmod +x mvnw
          ./mvnw clean package -DskipTests
      
      # 3. Build et push Docker
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/cdsir_backend:latest
      
      # 4. Déployer sur Kubernetes
      - name: Deploy to Kubernetes
        run: |
          # Installer kind
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind && sudo mv ./kind /usr/local/bin/
          
          # Installer kubectl
          curl -LO "https://dl.k8s.io/release/v1.27.0/bin/linux/amd64/kubectl"
          chmod +x kubectl && sudo mv kubectl /usr/local/bin/
          
          # Créer le cluster Kubernetes
          kind create cluster
          
          # Charger l'image Docker dans le cluster
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cdsir_backend:latest
          kind load docker-image ${{ secrets.DOCKERHUB_USERNAME }}/cdsir_backend:latest
          
          # Déployer l'application
          kubectl apply -f k8s/namespace.yaml
          
          # Mettre à jour et appliquer le deployment
          sed -e "s|image: cdsir_backend:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/cdsir_backend:latest|g" \
              -e "s|imagePullPolicy: Never|imagePullPolicy: IfNotPresent|g" \
              k8s/deployment.yaml | kubectl apply -f -
          
          kubectl apply -f k8s/service.yaml
          
          # Vérifier le déploiement
          echo "✅ Déploiement réussi !"
          sleep 5
          kubectl get all -n app
